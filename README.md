# ğŸš€ å›¾åºŠæœåŠ¡ (Tuchuang File Server)

ä¸€ä¸ª**ä¼ä¸šçº§ã€é«˜å®‰å…¨ã€é«˜æ€§èƒ½**çš„æ–‡ä»¶ç›´é“¾æ‰˜ç®¡æœåŠ¡ã€‚

ä¸“ä¸º JSON é…ç½®æ–‡ä»¶çš„åˆ†å‘è®¾è®¡ï¼Œå…·å¤‡**é€æ˜åŠ è§£å¯†**ã€**å³æ—¶å‹ç¼©**ã€**å“ˆå¸Œå»é‡**ã€**æ··åˆå­˜å‚¨**å’Œ**å…¨é“¾è·¯ç›‘æ§**èƒ½åŠ›ã€‚

> âœ¨ **é«˜åº¦æ¨¡å—åŒ–**ï¼šæ‰€æœ‰é«˜çº§ç‰¹æ€§ï¼ˆåŠ å¯†ã€å‹ç¼©ã€é‰´æƒã€Redisã€OSSï¼‰å‡ä¸º**å¯é€‰é…ç½®**ï¼Œé€šè¿‡ `.env` æ–‡ä»¶æŒ‰éœ€å¼€å¯ã€‚

---

## ğŸŒŸ æ ¸å¿ƒç‰¹æ€§

### 1. ğŸ”’ å®‰å…¨ç‰¹æ€§ [å¯é€‰]

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **é™æ€åŠ å¯†** | Fernet (AES-128) ç®—æ³•åŠ å¯†å­˜å‚¨ï¼ŒæœåŠ¡å™¨æ²¦é™·ä¹Ÿèƒ½ä¿æŠ¤æ•°æ® |
| **åŠ¨æ€è§£å¯†** | ä¸‹è½½æ—¶å®æ—¶è§£å¯†ï¼Œå†…å­˜æµå¼ä¼ è¾“ï¼Œæ— æ˜æ–‡ä¸´æ—¶æ–‡ä»¶ |
| **å†…å®¹æ ¡éªŒ** | å¼ºåˆ¶è§£æ JSON æ ¼å¼ï¼Œæ‹’ç»éæ³•æ–‡ä»¶ |
| **API é‰´æƒ** | æ”¯æŒ API Key éªŒè¯ï¼Œä¿æŠ¤ä¸Šä¼ æ¥å£ |
| **æ–‡ä»¶å¤§å°é™åˆ¶** | å¯é…ç½®æœ€å¤§æ–‡ä»¶å¤§å°ï¼ˆé»˜è®¤ 10MBï¼‰ |
| **CORS æ§åˆ¶** | å¯é…ç½®å…è®¸çš„è·¨åŸŸæ¥æº |

### 2. âš¡ æ€§èƒ½ä¼˜åŒ– [å¯é€‰]

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **orjson** | é«˜æ€§èƒ½ JSON è§£æï¼Œæ¯”æ ‡å‡†åº“å¿« 5-10 å€ |
| **Gzip å‹ç¼©** | å¯é…ç½®å‹ç¼©ç­‰çº§ï¼ˆ1-9ï¼‰ï¼ŒèŠ‚çœé«˜è¾¾ 80% ç©ºé—´ |
| **å“ˆå¸Œå»é‡** | MD5 æŒ‡çº¹è¯†åˆ«ï¼Œå®ç°"ç§’ä¼ "åŠŸèƒ½ |
| **aiosqlite** | å…¨å¼‚æ­¥æ•°æ®åº“ï¼Œæ— é˜»å¡æ“ä½œ |
| **HTTP å¤ç”¨** | å…¨å±€å¼‚æ­¥ HTTP å®¢æˆ·ç«¯ï¼Œå¤ç”¨ TCP è¿æ¥ |

### 3. ğŸ§  æ··åˆæ¶æ„ [å¯é€‰]

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **åŒé‡å­˜å‚¨** | æœ¬åœ°ç£ç›˜ + é˜¿é‡Œäº‘ OSS åŒå†™ |
| **æ··åˆé™æµ** | å†…å­˜é™æµ æˆ– Redis åˆ†å¸ƒå¼é™æµ |
| **ç”Ÿå‘½å‘¨æœŸ** | æ”¯æŒ 1å¤©/7å¤©/1æœˆ/æ°¸ä¹…ï¼Œè¿‡æœŸè‡ªåŠ¨æ¸…ç† |

### 4. ğŸ“Š å¯è§‚æµ‹æ€§ [é»˜è®¤å¼€å¯]

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **Prometheus** | `/metrics` ç«¯ç‚¹æš´éœ² QPSã€å»¶è¿Ÿã€é”™è¯¯ç‡ |
| **å¥åº·æ£€æŸ¥** | `/health` ç«¯ç‚¹è¿”å›å„ç»„ä»¶çŠ¶æ€ |
| **ç»“æ„åŒ–æ—¥å¿—** | Loguru æ—¥å¿—ï¼Œè‡ªåŠ¨è½®è½¬ã€ä¿ç•™ 30 å¤© |

---

## ğŸ“‚ ç›®å½•ç»“æ„

```text
tuchuang/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ api.py              # ğŸ›£ï¸ API è·¯ç”± (ä¸Šä¼ /ä¸‹è½½/å¥åº·æ£€æŸ¥/ç»Ÿè®¡)
â”‚   â”œâ”€â”€ models.py           # ğŸ“¦ Pydantic æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ services.py         # âš™ï¸ æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (ä¸Šä¼ /ä¸‹è½½/æ¸…ç†)
â”‚   â”œâ”€â”€ database.py         # ğŸ—„ï¸ å¼‚æ­¥æ•°æ®åº“ (aiosqlite)
â”‚   â”œâ”€â”€ exceptions.py       # âš ï¸ è‡ªå®šä¹‰å¼‚å¸¸ç±»
â”‚   â””â”€â”€ core/
â”‚       â”œâ”€â”€ config.py       # âš™ï¸ é…ç½®ç®¡ç† (pydantic-settings)
â”‚       â”œâ”€â”€ crypto.py       # ğŸ” åŠ è§£å¯†å¼•æ“ (Fernet)
â”‚       â”œâ”€â”€ http_client.py  # ğŸŒ å…¨å±€å¼‚æ­¥ HTTP å®¢æˆ·ç«¯
â”‚       â”œâ”€â”€ logger.py       # ğŸ“ æ—¥å¿—é…ç½® (Loguru)
â”‚       â”œâ”€â”€ oss_client.py   # â˜ï¸ é˜¿é‡Œäº‘ OSS å®¢æˆ·ç«¯
â”‚       â””â”€â”€ security.py     # ğŸš¦ é™æµä¸é‰´æƒ
â”œâ”€â”€ static/
â”‚   â””â”€â”€ favicon.ico         # ğŸ¨ ç½‘ç«™å›¾æ ‡
â”œâ”€â”€ uploads/                # ğŸ“ æœ¬åœ°å­˜å‚¨ç›®å½•
â”œâ”€â”€ logs/                   # ğŸ“ è¿è¡Œæ—¥å¿—
â”œâ”€â”€ docs/                   # ğŸ“š æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ DEPLOYMENT.md       # ğŸš€ éƒ¨ç½²æŒ‡å—
â”‚   â”œâ”€â”€ ERROR_CODES.md      # âš ï¸ é”™è¯¯ç æ–‡æ¡£
â”‚   â””â”€â”€ TROUBLESHOOTING.md  # ğŸ”§ æ•…éšœæ’æŸ¥
â”œâ”€â”€ .env                    # âš™ï¸ é…ç½®æ–‡ä»¶
â”œâ”€â”€ .env.example            # ğŸ“„ é…ç½®ç¤ºä¾‹
â”œâ”€â”€ pyproject.toml          # ğŸ“¦ ä¾èµ–é…ç½®
â”œâ”€â”€ docker-compose.yml      # ğŸ³ Docker ç¼–æ’
â”œâ”€â”€ Dockerfile              # ğŸ³ é•œåƒæ„å»º
â””â”€â”€ main.py                 # ğŸš€ åº”ç”¨å…¥å£
```

---

## ğŸ“š æ–‡æ¡£å¯¼èˆª

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| [éƒ¨ç½²æŒ‡å—](docs/DEPLOYMENT.md) | ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ã€ç›‘æ§ã€å¤‡ä»½ã€å®‰å…¨å»ºè®® |
| [é”™è¯¯ç æ–‡æ¡£](docs/ERROR_CODES.md) | HTTP çŠ¶æ€ç ã€ä¸šåŠ¡é”™è¯¯ç ã€é”™è¯¯å“åº”æ ¼å¼ |
| [æ•…éšœæ’æŸ¥](docs/TROUBLESHOOTING.md) | å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ |

---

## ğŸ› ï¸ å¿«é€Ÿéƒ¨ç½²

### æ–¹å¼ A: Docker éƒ¨ç½² (æ¨è)

```bash
# 1. å¤åˆ¶é…ç½®æ–‡ä»¶
cp .env.example .env

# 2. ç”ŸæˆåŠ å¯†å¯†é’¥ï¼ˆå¦‚éœ€å¼€å¯åŠ å¯†ï¼‰
docker run --rm python:3.12 python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"

# 3. ç¼–è¾‘ .envï¼Œå¡«å…¥å¿…è¦é…ç½®
# HOST_DOMAIN=http://your-domain:8000
# ENCRYPTION_KEY=ç”Ÿæˆçš„å¯†é’¥

# 4. å¯åŠ¨æœåŠ¡
docker-compose up -d --build
```

### æ–¹å¼ B: æœ¬åœ°éƒ¨ç½² (ä½¿ç”¨ uv)

```bash
# 1. å®‰è£… uv
curl -LsSf https://astral.sh/uv/install.sh | sh

# 2. å®‰è£…ä¾èµ–
uv sync

# 3. ç”ŸæˆåŠ å¯†å¯†é’¥ï¼ˆå¦‚éœ€å¼€å¯åŠ å¯†ï¼‰
uv run python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"

# 4. ç¼–è¾‘ .envï¼Œå¡«å…¥å¿…è¦é…ç½®
cp .env.example .env

# 5. å¯åŠ¨æœåŠ¡
uv run main.py
```

æœåŠ¡å¯åŠ¨åè®¿é—®ï¼š
- API æ–‡æ¡£: http://localhost:8000/docs
- å¥åº·æ£€æŸ¥: http://localhost:8000/health
- Prometheus æŒ‡æ ‡: http://localhost:8000/metrics

---

## âš™ï¸ é…ç½®è¯´æ˜ (.env)

æ‰€æœ‰é…ç½®é€šè¿‡ `.env` æ–‡ä»¶æ§åˆ¶ï¼Œ**å¿…å¡«é¡¹ç¼ºå¤±æ—¶æœåŠ¡æ— æ³•å¯åŠ¨**ã€‚

### åŸºç¡€é…ç½® [å¿…å¡«]

| å˜é‡ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `HOST_DOMAIN` | æœåŠ¡å¯¹å¤–åŸŸå/IPï¼Œç”¨äºç”Ÿæˆç›´é“¾ | `http://127.0.0.1:8000` |

### å®‰å…¨é…ç½® [å¯é€‰]

| å˜é‡ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `AUTH_ENABLED` | `false` | æ˜¯å¦å¼€å¯ API Key é‰´æƒ |
| `API_KEY` | `secret` | é‰´æƒå¯†é’¥ |
| `ENCRYPTION_ENABLED` | `false` | æ˜¯å¦å¼€å¯æ–‡ä»¶åŠ å¯† |
| `ENCRYPTION_KEY` | - | Fernet å¯†é’¥ï¼ˆå¼€å¯åŠ å¯†æ—¶å¿…å¡«ï¼‰ |
| `MAX_FILE_SIZE` | `10485760` | æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆå­—èŠ‚ï¼Œé»˜è®¤ 10MBï¼‰ |
| `CORS_ORIGINS` | `*` | CORS å…è®¸æ¥æºï¼ˆé€—å·åˆ†éš”ï¼‰ |

### æ€§èƒ½é…ç½® [å¯é€‰]

| å˜é‡ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `COMPRESSION_ENABLED` | `false` | æ˜¯å¦å¼€å¯ Gzip å‹ç¼© |
| `COMPRESSION_LEVEL` | `6` | å‹ç¼©ç­‰çº§ï¼ˆ1-9ï¼‰ |
| `RATE_LIMIT` | `60/minute` | é™æµè§„åˆ™ |
| `REDIS_URL` | - | Redis åœ°å€ï¼ˆç•™ç©ºä½¿ç”¨å†…å­˜é™æµï¼‰ |

### OSS äº‘å­˜å‚¨ [å¯é€‰]

| å˜é‡ | è¯´æ˜ |
|------|------|
| `ENABLE_OSS` | æ˜¯å¦å¯ç”¨ OSS |
| `OSS_ENDPOINT` | OSS Endpointï¼ˆå¦‚ï¼šoss-cn-hangzhou.aliyuncs.comï¼‰ |
| `OSS_BUCKET` | Bucket åç§° |
| `OSS_AK` | AccessKey ID |
| `OSS_SK` | AccessKey Secret |
| `OSS_DOMAIN` | OSS å…¬ç½‘è®¿é—®åŸŸå |

---

## ğŸ”Œ API æ¥å£æ–‡æ¡£

### 1. ä¸Šä¼ æ–‡ä»¶

```bash
POST /upload
```

**è¯·æ±‚å‚æ•°ï¼š**

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `file` | File | æ˜¯ | JSON æ–‡ä»¶ |
| `time_limit` | String | å¦ | æœ‰æ•ˆæœŸï¼š`1d` / `7d` / `1m` / `perm` |

**è¯·æ±‚å¤´ï¼ˆé‰´æƒå¼€å¯æ—¶ï¼‰ï¼š**
```
x-api-key: your-secret-key
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "msg": "âœ… ä¸Šä¼ æˆåŠŸ",
  "data": {
    "url": "http://127.0.0.1:8000/f/a1b2c3d4",
    "filename": "config.json",
    "expiry": "æ°¸ä¹…",
    "is_duplicate": false
  }
}
```

### 2. è·å–æ–‡ä»¶

```bash
GET /f/{file_id}
```

è‡ªåŠ¨å¤„ç†ï¼š`è¯»å–ç£ç›˜ -> è§£å¯† (AES) -> è§£å‹ (Gzip) -> è¿”å› JSON`

### 3. å¥åº·æ£€æŸ¥

```bash
GET /health
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "status": "ğŸŸ¢ healthy",
  "version": "1.0.0",
  "components": {
    "database": "ğŸŸ¢ OK",
    "encryption": "ğŸ”´ Disabled",
    "compression": "ğŸŸ¢ Enabled",
    "oss": "ğŸ”´ Disabled",
    "redis": "ğŸ”´ Disabled"
  }
}
```

### 4. ç³»ç»Ÿç»Ÿè®¡

```bash
GET /admin/stats
```

è¿”å›æ–‡ä»¶æ€»æ•°å’Œç³»ç»Ÿé…ç½®çŠ¶æ€ã€‚

### 5. Prometheus æŒ‡æ ‡

```bash
GET /metrics
```

Prometheus æ ¼å¼çš„ç›‘æ§æŒ‡æ ‡ã€‚

---

## ğŸ“± Legado (é˜…è¯») é€‚é…

é…ç½® JSONï¼š

```json
{
  "summary": "å›¾åºŠæœåŠ¡",
  "uploadUrl": "http://your-domain:8000/upload,{\"method\":\"POST\",\"type\":\"multipart/form-data\",\"body\":{\"file\":\"fileRequest\",\"time_limit\":\"perm\"},\"headers\":{\"x-api-key\":\"your-key\"}}",
  "downloadUrlRule": "$.data.url",
  "compress": false
}
```

**è¯´æ˜ï¼š**
- ä¿®æ”¹ `your-domain` ä¸ºå®é™…åœ°å€
- å¦‚å¼€å¯é‰´æƒï¼Œä¿®æ”¹ `x-api-key` ä¸ºå®é™…å¯†é’¥
- `time_limit`: `1d`(1å¤©) / `7d`(7å¤©) / `1m`(1æœˆ) / `perm`(æ°¸ä¹…)

---

## ğŸ—ï¸ å·¥ä½œæµç¨‹

### å†™å…¥æµç¨‹

```
æ¥æ”¶æ–‡ä»¶
  â†’ å¤§å°æ£€æŸ¥
  â†’ åç¼€åæ ¡éªŒ
  â†’ JSON æ ¡éªŒä¸å‹ç¼©
  â†’ MD5 å“ˆå¸Œè®¡ç®—
  â†’ [å»é‡æ£€æŸ¥ â†’ ç§’ä¼ ]
  â†’ Gzip å‹ç¼© (å¯é€‰)
  â†’ Fernet åŠ å¯† (å¯é€‰)
  â†’ æœ¬åœ°å­˜å‚¨
  â†’ OSS ä¸Šä¼  (å¯é€‰)
  â†’ å†™å…¥å…ƒæ•°æ®
```

### è¯»å–æµç¨‹

```
æŸ¥è¯¢æ•°æ®åº“
  â†’ è¯»å–æœ¬åœ°æ–‡ä»¶
  â†’ Fernet è§£å¯† (å¦‚åŠ å¯†)
  â†’ Gzip è§£å‹ (å¦‚å‹ç¼©)
  â†’ è¿”å› JSON
```

---

## ğŸ“ ç»´æŠ¤

- **è‡ªåŠ¨æ¸…ç†**: åå°ä»»åŠ¡æ¯å°æ—¶æ¸…ç†è¿‡æœŸæ–‡ä»¶
- **æ—¥å¿—è½®è½¬**: `logs/` ç›®å½•ï¼ŒæŒ‰å¤©åˆ‡å‰²ï¼Œä¿ç•™ 30 å¤©
- **ä¼˜é›…å…³é—­**: æ”¯æŒä¿¡å·å¤„ç†ï¼Œå®Œæˆåå°ä»»åŠ¡å†é€€å‡º

---

## ğŸ“„ è®¸å¯è¯

MIT License
