# ==========================================
# ğŸ³ å›¾åºŠæœåŠ¡ Docker Compose é…ç½®
# ==========================================
# ä½¿ç”¨æ–¹æ³•:
#   1. å¤åˆ¶ .env.example ä¸º .env å¹¶ä¿®æ”¹é…ç½®
#   2. è¿è¡Œ: docker-compose up -d --build
# ==========================================

services:
  # ==========================================
  # ğŸš€ å›¾åºŠæœåŠ¡ä¸»å®¹å™¨
  # ==========================================
  tuchuang:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tuchuang_server
    restart: unless-stopped

    # ç«¯å£æ˜ å°„
    ports:
      - "8000:8000"

    # æ•°æ®å·æŒ‚è½½ (æŒä¹…åŒ–æ•°æ®)
    volumes:
      - ./uploads:/app/uploads          # æœ¬åœ°å­˜å‚¨ç›®å½•
      - tuchuang_db:/app/data           # æ•°æ®ç›®å½•ï¼ˆä½¿ç”¨å‘½åå·é¿å…æ–‡ä»¶/ç›®å½•å†²çªï¼‰
      - ./logs:/app/logs                # æ—¥å¿—ç›®å½•

    # ç¯å¢ƒå˜é‡ (ä¹Ÿå¯é€šè¿‡ .env æ–‡ä»¶é…ç½®)
    environment:
      # ========== åŸºç¡€é…ç½® [å¿…å¡«] ==========
      - HOST_DOMAIN=${HOST_DOMAIN:-http://127.0.0.1:8000}

      # ========== é‰´æƒé…ç½® ==========
      - AUTH_ENABLED=${AUTH_ENABLED:-false}
      - API_KEY=${API_KEY:-secret}

      # ========== åŠ å¯†é…ç½® ==========
      - ENCRYPTION_ENABLED=${ENCRYPTION_ENABLED:-false}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-}

      # ========== å‹ç¼©é…ç½® ==========
      - COMPRESSION_ENABLED=${COMPRESSION_ENABLED:-false}
      - COMPRESSION_LEVEL=${COMPRESSION_LEVEL:-6}

      # ========== OSS äº‘å­˜å‚¨ ==========
      - ENABLE_OSS=${ENABLE_OSS:-false}
      - OSS_ENDPOINT=${OSS_ENDPOINT:-}
      - OSS_BUCKET=${OSS_BUCKET:-}
      - OSS_AK=${OSS_AK:-}
      - OSS_SK=${OSS_SK:-}
      - OSS_DOMAIN=${OSS_DOMAIN:-}

      # ========== é™æµé…ç½® ==========
      - RATE_LIMIT=${RATE_LIMIT:-60/minute}
      - REDIS_URL=${REDIS_URL:-}

      # ========== å®‰å…¨é…ç½® ==========
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-10485760}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}

    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3

    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # èµ„æºé™åˆ¶ (å¯é€‰)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '1'
    #       memory: 512M
    #     reservations:
    #       cpus: '0.5'
    #       memory: 256M

  # ==========================================
  # ğŸ¨ ç®¡ç†åå°å‰ç«¯
  # ==========================================
  admin:
    build:
      context: ./admin
      dockerfile: Dockerfile
    container_name: tuchuang_admin
    restart: unless-stopped

    # ç«¯å£æ˜ å°„
    ports:
      - "3000:3000"

    # ç¯å¢ƒå˜é‡
    environment:
      - NEXT_PUBLIC_API_URL=http://tuchuang:8000
      - NEXT_PUBLIC_API_KEY=${API_KEY:-}

    # ä¾èµ–åç«¯æœåŠ¡
    depends_on:
      - tuchuang

    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      start_period: 20s
      retries: 3

    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================
  # ğŸ“Š Prometheus (å¯é€‰ç›‘æ§)
  # ==========================================
  # å–æ¶ˆæ³¨é‡Šä»¥å¯ç”¨ Prometheus ç›‘æ§
  # prometheus:
  #   image: prom/prometheus:latest
  #   container_name: tuchuang_prometheus
  #   restart: unless-stopped
  #   ports:
  #     - "9090:9090"
  #   volumes:
  #     - ./prometheus.yml:/etc/prometheus/prometheus.yml
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #   depends_on:
  #     - tuchuang

  # ==========================================
  # ğŸ”´ Redis (å¯é€‰åˆ†å¸ƒå¼é™æµ)
  # ==========================================
  # å–æ¶ˆæ³¨é‡Šä»¥å¯ç”¨ Redis åˆ†å¸ƒå¼é™æµ
  # redis:
  #   image: redis:7-alpine
  #   container_name: tuchuang_redis
  #   restart: unless-stopped
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis_data:/data

# æŒä¹…åŒ–æ•°æ®å·
volumes:
  tuchuang_db:                    # æ•°æ®åº“å‘½åå·
    driver: local
  # redis_data:                   # Redis å·ï¼ˆå¯ç”¨æ—¶å–æ¶ˆæ³¨é‡Šï¼‰
