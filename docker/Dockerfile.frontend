# ==========================================
# ğŸ³ ç®¡ç†åå° Docker é•œåƒ
# ==========================================
# å¤šé˜¶æ®µæ„å»º:
#   1. deps: å®‰è£…ä¾èµ–
#   2. builder: æ„å»ºåº”ç”¨
#   3. runner: ç”Ÿäº§ç¯å¢ƒè¿è¡Œ
# ==========================================

# ==========================================
# é˜¶æ®µ 1: ä¾èµ–å®‰è£…
# ==========================================
FROM node:20-alpine AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY admin/package.json admin/package-lock.json* ./
# å®‰è£…ä¾èµ–
RUN npm ci

# ==========================================
# é˜¶æ®µ 2: æ„å»º
# ==========================================
FROM node:20-alpine AS builder
WORKDIR /app

# å¤åˆ¶ä¾èµ–
COPY --from=deps /app/node_modules ./node_modules
COPY admin/ ./

# è®¾ç½®æ„å»ºæ—¶ç¯å¢ƒå˜é‡
ENV NEXT_TELEMETRY_DISABLED=1
ENV NODE_ENV=production

# ç¡®ä¿ public ç›®å½•å­˜åœ¨
RUN mkdir -p public

# æ„å»ºåº”ç”¨
RUN npm run build

# ==========================================
# é˜¶æ®µ 3: ç”Ÿäº§è¿è¡Œ
# ==========================================
FROM node:20-alpine AS runner
WORKDIR /app

# æ·»åŠ é root ç”¨æˆ·
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/public ./public/

# è®¾ç½®æƒé™
RUN chown -R nextjs:nodejs /app

USER nextjs

EXPOSE 3000

CMD ["node", "server.js"]
